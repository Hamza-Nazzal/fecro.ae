HubGate Backend Database — Full Architecture & Rules (Complete Updated Spec)

Version: 2025-12-08

(Includes SECURITY INVOKER fixes, seller–buyer contact logic, company isolation, RFQ normalization, quotations, events, RLS policies, Worker contracts, and all DB objects.)

⸻

1. Overview

This document is the authoritative specification of the HubGate database — schema, RLS, views, RPCs, triggers, and Worker contracts.

Covers:
	•	RFQs (header + items + specs)
	•	Quotations (header + items + seller specs)
	•	Category taxonomy
	•	Companies & memberships
	•	Contact unlocking
	•	Seller RFQ ID system
	•	Audit/event logging
	•	RLS, security boundaries
	•	Worker responsibilities
	•	All DB objects and triggers
	•	Supabase-specific rules (security_invoker, linter OK)

⸻

2. Schema Index (Canonical)

2.1 RFQ Core Tables

rfqs

Columns:
	•	id uuid PK
	•	public_id text — buyer-facing ID (RFQ-100123)
	•	seller_rfq_id text — seller-facing ID (SRF-AB12CD34EF)
	•	title text
	•	description text
	•	status text — active/closed
	•	posted_time timestamptz default now()
	•	user_id uuid — RFQ owner (buyer user)
	•	buyer_company_id uuid — required
	•	Commercial fields: incoterms, payment, delivery_time
	•	Metrics: quotations, views

Indexes:
	•	idx_rfqs_user_id
	•	idx_rfqs_buyer_company_id
	•	rfqs_seller_rfq_id_uniq

⸻

Trigger: Auto-generate seller_rfq_id

rfq_set_seller_rfq_id()
trg_rfqs_set_seller_rfq_id

Format:

SRF-XXXXXXXXXX


⸻

2.2 RFQ Items

rfq_items
	•	id uuid PK
	•	rfq_id uuid FK
	•	product_name text
	•	barcode text
	•	quantity numeric
	•	purchase_type text
	•	category_path text (optional convenience)

Index:
	•	idx_rfq_items_rfq_id

⸻

2.3 RFQ Specifications

rfq_item_specs
	•	id uuid PK
	•	rfq_item_id uuid FK
	•	key_norm text
	•	key_label text
	•	value text
	•	unit text

Unique:

(rfq_item_id, key_norm)


⸻

3. RPC Functions

3.1 rfq_upsert_items_and_specs(rfq_id, items_jsonb)

Atomic:
	•	Inserts/updates items
	•	Inserts/updates specs
	•	Enforces normalization

Used by:
	•	createRFQ
	•	updateRFQ

⸻

3.2 Seller Hydration RPC (rfq_hydrate_seller)

Returns:
	•	RFQ header
	•	Items
	•	Buyer specifications

Security:
	•	SECURITY DEFINER
	•	Callable only by Worker (service_key)
	•	Worker pre-checks:
	•	RFQ exists
	•	status = active
	•	buyer_company_id ≠ seller_company_id

⸻

4. Quotations

4.1 quotations

Columns:
	•	id uuid PK
	•	rfq_id uuid
	•	seller_id uuid
	•	seller_company_id uuid
	•	created_by_membership_id uuid
	•	status text — draft/submitted/approved/rejected
	•	total_price numeric
	•	currency text default 'AED'
	•	delivery_timeline_days integer
	•	validity_days integer
	•	payment_terms text
	•	shipping_terms text
	•	notes text
	•	internal_reference text
	•	seller_company text (denormalized)
	•	Timestamps: submitted_at, expires_at, created_at, updated_at

Indexes:
	•	quotations_rfq_id_idx
	•	quotations_seller_id_idx
	•	quotations_status_idx

⸻

4.2 quotation_items

Per RFQ item quoted:
	•	id uuid PK
	•	quotation_id uuid FK
	•	rfq_item_id uuid FK
	•	unit_price numeric
	•	unit text
	•	qty_offer numeric
	•	Discounts
	•	Warranty
	•	Timestamps

⸻

4.3 quotation_item_specs

Seller-side specs:
	•	id uuid PK
	•	quotation_id uuid
	•	rfq_item_id uuid
	•	rfq_spec_id uuid
	•	key_norm
	•	key_label
	•	value
	•	unit
	•	source — buyer/seller
	•	decision — included/excluded/custom
	•	sort_order

⸻

4.4 Contact Unlocking

Field on quotations:

contacts_unlocked boolean

Rules:
	•	Locked by default
	•	Unlocked only when interest.status = ‘approved’
	•	Both sides must satisfy:
	•	interest approved
	•	contacts_unlocked true
	•	company info exists

⸻

5. Company System

5.1 companies
	•	id uuid PK
	•	name text (unique, case-insensitive)
	•	created_at timestamptz default now()

Constraint:

ux_companies_lower_name (lower(name))


⸻

5.2 company_memberships
	•	id uuid PK
	•	company_id uuid FK
	•	user_id uuid FK
	•	track text (procurement/sales)
	•	role_level int
	•	Timestamps

Unique:

(company_id, user_id)


⸻

5.3 company_invites
	•	id uuid PK
	•	company_id uuid FK
	•	email text
	•	invited_by uuid
	•	status text (pending/accepted)
	•	token uuid unique
	•	created_at, accepted_at

⸻

6. Category System

Tables:
	•	categories
	•	staging_unspsc_nodes
	•	staging_category_paths
	•	suggestion tables

Functions:
	•	category_upsert_path
	•	category_import_from_staging_batch
	•	categories_search
	•	category_set_active
	•	set_rfq_category
	•	set_product_category

Tree rules:
	•	derived breadcrumbs
	•	depth maintenance
	•	loop prevention
	•	unique siblings per scheme
	•	unique full path per scheme

⸻

7. Views (App-Facing)

7.1 v_rfqs_card (fixed to SECURITY INVOKER)

SELECT r.id,
       r.public_id,
       r.seller_rfq_id,
       r.title,
       r.status,
       r.posted_time,
       r.quotations,
       r.views,
       c.name AS company_name
FROM rfqs r
JOIN companies c ON c.id = r.buyer_company_id;

State:
	•	SECURITY INVOKER
	•	RLS applies
	•	GRANT SELECT TO authenticated, service_role

⸻

7.2 v_quotation_interest_summary (SECURITY INVOKER)

SELECT quotation_id,
       COUNT(*) FILTER (WHERE status='pending') AS pending_count,
       COUNT(*) FILTER (WHERE status='approved') AS approved_count,
       COUNT(*) FILTER (WHERE status='rejected') AS rejected_count
FROM quotation_interest
GROUP BY quotation_id;


⸻

7.3 Spec Views
	•	v_quotation_item_specs_included
	•	v_quotation_item_specs_seller

Both SECURITY INVOKER.

⸻

8. RLS (Master Summary)

8.1 RFQs

Buyers:

user_id = auth.uid()

Sellers:
	•	Cannot access RFQs directly
	•	Must use Worker → RPC → hydrated results

⸻

8.2 Quotations

Seller CUD:

seller_id = auth.uid()

Buyer read:

rfqs.user_id = auth.uid()

Self-quoting blocked:

rfqs.buyer_company_id != quotations.seller_company_id


⸻

8.3 Company Tables

Writes:
	•	service_role only

Reads:
	•	minimal exposure
	•	Worker uses service_role to load user.company_id

⸻

8.4 Audit Tables
	•	RLS enabled
	•	service_role only

⸻

9. Seller RFQ Hydration Flow
	1.	React → Worker:

/seller/rfq/hydrate?id=<rfq_id>

	2.	Worker:

	•	validate JWT
	•	load membership (service_key)
	•	confirm seller company
	•	ensure RFQ active
	•	ensure buyer_company_id ≠ seller_company_id

	3.	Worker calls RPC:

select * from public.rfq_hydrate_seller(...)

	4.	RPC returns JSON:

	•	header
	•	nested items
	•	buyer specs
	•	category last path
	•	delivery/payment

⸻

10. Contact Sharing Logic (Final)

Conditions to display contact block:
	•	For buyer view:

userRole = 'buyer'
interest.status = 'approved'
quotation.contacts_unlocked = true
seller has company info

	•	For seller view:

userRole = 'seller'
interest.status = 'approved'
quotation.contacts_unlocked = true
buyer has company info

Company info includes:
	•	company_name
	•	company_phone
	•	city
	•	state
	•	country

⸻

11. Audit & Event Logs

Tables:
	•	user_role_audit_log
	•	company_membership_audit_log
	•	rfq_event_log
	•	quotation_event_log

All:
	•	SECURITY DEFINER triggers
	•	RLS locked to service_role
	•	Append-only

⸻

12. Worker Responsibilities

Worker performs all privileged operations:
	•	createCompany
	•	inviteCompanyUser
	•	acceptCompanyInvite
	•	seller RFQ list
	•	seller RFQ hydrate
	•	identity resolution (user.company_id)
	•	contact unlocking logic
	•	preventing company self-quoting

The React app never uses service_key.

⸻

13. Final System Status (Dec 2025)

✅ Categories stable
✅ RFQs normalized
✅ Items + specs normalized
✅ Seller RFQ IDs fully migrated
✅ Quotation contact logic fixed
✅ SECURITY INVOKER views applied
✅ Supabase linter clean
✅ Company isolation functional
✅ Hydration stable
✅ Worker enforcing all secure paths

